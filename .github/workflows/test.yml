# Test Pipeline for Dressing Intelligent
# Enhanced CI with burn-in loops, coverage, and artifact collection
# Generated by BMad TestArch CI workflow

name: Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  # Weekly burn-in for stability check
  schedule:
    - cron: '0 3 * * 0' # Sundays at 3 AM UTC

env:
  NODE_VERSION: '20'

jobs:
  # ============================================================
  # Stage 1: Lint & TypeCheck (fast feedback)
  # ============================================================
  lint:
    name: Lint & TypeCheck
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm lint

      - name: TypeScript Check
        run: pnpm typecheck

  # ============================================================
  # Stage 2: Unit Tests with Coverage
  # ============================================================
  test:
    name: Test (Shard ${{ matrix.shard }})
    runs-on: ubuntu-latest
    needs: lint
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests with coverage
        run: |
          pnpm test -- \
            --coverage \
            --coverageReporters=text \
            --coverageReporters=html \
            --shard=${{ matrix.shard }}/${{ strategy.job-total }}
        env:
          CI: true

      - name: Upload coverage artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-shard-${{ matrix.shard }}
          path: coverage/
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload test failure artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-failures-shard-${{ matrix.shard }}
          path: |
            coverage/
            __tests__/__snapshots__/
          retention-days: 30

  # ============================================================
  # Stage 3: Expo Doctor (health check)
  # ============================================================
  expo-doctor:
    name: Expo Doctor
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Expo Doctor
        run: pnpm expo:doctor

  # ============================================================
  # Stage 4: Burn-In Loop (flaky test detection)
  # Runs on PRs to main and weekly schedule
  # ============================================================
  burn-in:
    name: Burn-In (Flaky Detection)
    runs-on: ubuntu-latest
    needs: lint
    if: |
      github.event_name == 'schedule' ||
      (github.event_name == 'pull_request' && github.base_ref == 'main')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run burn-in loop (10 iterations)
        run: |
          echo "ðŸ”¥ Starting burn-in loop to detect flaky tests..."
          for i in {1..10}; do
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ðŸ”¥ Burn-in iteration $i/10"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            pnpm test || {
              echo ""
              echo "âŒ FLAKY TEST DETECTED at iteration $i"
              echo "Tests passed $((i-1)) times before failing."
              echo "Please investigate and fix before merging."
              exit 1
            }
          done
          echo ""
          echo "âœ… All 10 burn-in iterations passed! Tests are stable."

      - name: Upload burn-in failure artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: burn-in-failures
          path: |
            coverage/
            __tests__/__snapshots__/
          retention-days: 30

  # ============================================================
  # Stage 5: Deploy (main branch only)
  # ============================================================
  deploy:
    name: Sentry Release
    runs-on: ubuntu-latest
    needs: [test, expo-doctor]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Note: continue-on-error allows CI to pass even if Sentry secrets aren't configured
      - name: Upload Source Maps to Sentry
        continue-on-error: true
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
        run: |
          VERSION=$(node -p "require('./package.json').version")
          npx @sentry/cli releases new "dressing-intelligent@${VERSION}"
          npx @sentry/cli releases files "dressing-intelligent@${VERSION}" upload-sourcemaps ./dist --ignore node_modules || true
          npx @sentry/cli releases finalize "dressing-intelligent@${VERSION}"
          echo "âœ… Sentry release dressing-intelligent@${VERSION} created"
